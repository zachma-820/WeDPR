<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.webank.wedpr.components.dataset.mapper.DatasetMapper">
    <resultMap id="DatasetResultMap" type="com.webank.wedpr.components.dataset.dao.Dataset">
        <id property="datasetId" column="dataset_id" />
        <result property="datasetId" column="dataset_id" />
        <result property="datasetTitle" column="dataset_title" />
        <result property="datasetLabel" column="dataset_label" />
        <result property="datasetDesc" column="dataset_desc" />
        <result property="datasetFields" column="dataset_fields" />
        <result property="datasetVersionHash" column="dataset_version_hash" />
        <result property="datasetSize" column="dataset_data_size" />
        <result property="datasetRecordCount" column="dataset_record_count" />
        <result property="datasetColumnCount" column="dataset_column_count" />
        <result property="datasetStorageType" column="dataset_storage_type" />
        <result property="datasetStoragePath" column="dataset_storage_path" />
        <result property="ownerAgencyId" column="owner_agency_id" />
        <result property="ownerAgencyName" column="owner_agency_name" />
        <result property="ownerUserId" column="owner_user_id" />
        <result property="ownerUserName" column="owner_user_name" />
        <result property="dataSourceType" column="data_source_type" />
        <result property="dataSourceMeta" column="data_source_meta" />
        <result property="visibility" column="visibility" />
        <result property="visibilityDetails" column="visibility_details" />
        <result property="status" column="status" />
        <result property="statusDesc" column="status_desc" />
        <result property="createAt" column="create_at" />
        <result property="updateAt" column="update_at" />
    </resultMap>

    <select id="getDatasetByDatasetId" resultMap="DatasetResultMap">
        SELECT
            dataset_id,
            dataset_title,
            dataset_label,
            dataset_desc,
            dataset_fields,
            dataset_version_hash,
            dataset_data_size,
            dataset_record_count,
            dataset_column_count,
            dataset_storage_type,
            dataset_storage_path,
            owner_agency_id,
            owner_agency_name,
            owner_user_id,
            owner_user_name,
            data_source_type,
            data_source_meta,
            visibility,
            visibility_details,
            status,
            status_desc,
            create_at,
            update_at
        FROM
            wedpr_dataset
        WHERE
            dataset_id = #{datasetId}

        <if test="isTx == true">
            for update
        </if>
    </select>


    <select id="getDatasetId" parameterType="String" resultType="String">
        SELECT dataset_id FROM wedpr_dataset WHERE dataset_id = #{datasetId}
    </select>

    <select id="queryVisibleDatasetsForUser" resultMap="DatasetResultMap">
        SELECT
          t1.*
        FROM
          (
            SELECT
              distinct dataset_id
            FROM
              wedpr_dataset_permission
            WHERE
              (1 = 1)
                <if test="permissionType != null">
                    AND (permission_type = #{permissionType})
                </if>
              AND
                    CURDATE() &lt;= expired_at
              AND (
                permission_scope = 'global'
                OR (
                  permission_scope = 'agency'
                  AND permission_subject_id = #{loginAgency}
                )
        <if test="loginUserGroupSubjectList != null and !loginUserGroupSubjectList.isEmpty()">
                OR (
                  permission_scope = 'user_group'
                    AND permission_subject_id IN
                    <foreach item="loginUserGroupSubject" index="index" collection="loginUserGroupSubjectList" open="(" separator="," close=")">
                        #{loginUserGroupSubject}
                    </foreach>
                )
        </if>
                OR (
                  permission_scope = 'user'
                  AND permission_subject_id = #{loginUserSubject}
                )
              )
          ) AS t2
          INNER JOIN wedpr_dataset t1 ON t1.dataset_id = t2.dataset_id
        WHERE
            1 = 1
            <if test="datasetTitle != null and datasetTitle.trim() != ''">
                AND t1.dataset_title LIKE CONCAT(#{datasetTitle}, '%')
            </if>

            <if test="startTime != null and startTime.trim() != ''">
                <![CDATA[ and DATEDIFF(t1.create_at, #{startTime}) >= 0]]>
            </if>

            <if test="endTime != null and endTime.trim() != ''">
                <![CDATA[ and DATEDIFF(t1.create_at, #{endTime}) <= 0]]>
            </if>

            <if test="ownerUser != null and ownerUser.trim() != ''">
                AND t1.owner_user_name = #{ownerUser}
            </if>
            <if test="ownerAgency != null and ownerAgency.trim() != ''">
                AND t1.owner_agency_name = #{ownerAgency}
            </if>
        ORDER BY
          t1.create_at DESC
        <if test="pageOffset >= 0">
            limit #{pageOffset}, #{pageSize}
        </if>
    </select>

    <select id="countVisibleDatasetsForUser" resultType="java.lang.Integer">
        SELECT
          COUNT(*)
        FROM
          (
            SELECT
              t1.dataset_id
            FROM
              wedpr_dataset t1
            WHERE
                1 = 1
                <if test="datasetTitle != null and datasetTitle.trim() != ''">
                    AND t1.dataset_title LIKE CONCAT(#{datasetTitle}, '%')
                </if>

                <if test="startTime != null and startTime.trim() != ''">
                    <![CDATA[ and DATEDIFF(t1.create_at, #{startTime}) >= 0]]>
                </if>

                <if test="endTime != null and endTime.trim() != ''">
                    <![CDATA[ and DATEDIFF(t1.create_at, #{endTime}) <= 0]]>
                </if>

                <if test="ownerUser != null and ownerUser.trim() != ''">
                    AND t1.owner_user_name = #{ownerUser}
                </if>
                <if test="ownerAgency != null and ownerAgency.trim() != ''">
                    AND t1.owner_agency_name = #{ownerAgency}
                </if>
          ) AS t1
          INNER JOIN (
            SELECT
              distinct dataset_id
            FROM
              wedpr_dataset_permission
            WHERE
                (1 = 1)
                <if test="permissionType != null">
                    AND (permission_type = #{permissionType})
                </if>
              AND
                    CURDATE() &lt;= expired_at
              AND (
                permission_scope = 'global'
                OR (
                  permission_scope = 'agency'
                  AND permission_subject_id = #{loginAgency}
                )

         <if test="loginUserGroupSubjectList != null and !loginUserGroupSubjectList.isEmpty()">
                OR (
                  permission_scope = 'user_group'
                    AND permission_subject_id IN
                    <foreach item="loginUserGroupSubject" index="index" collection="loginUserGroupSubjectList" open="(" separator="," close=")">
                        #{loginUserGroupSubject}
                    </foreach>
                )
        </if>
                OR (
                  permission_scope = 'user'
                  AND permission_subject_id = #{loginUserSubject}
                )
              )
          ) AS t2
          ON t1.dataset_id = t2.dataset_id
    </select>

    <insert id="insertDataset" parameterType="com.webank.wedpr.components.dataset.dao.Dataset">
        INSERT INTO wedpr_dataset (
            dataset_id,
            dataset_title,
            dataset_label,
            dataset_desc,
            owner_agency_id,
            owner_agency_name,
            owner_user_id,
            owner_user_name,
            dataset_fields,
            dataset_version_hash,
            dataset_data_size,
            dataset_record_count,
            dataset_column_count,
            dataset_storage_type,
            dataset_storage_path,
            data_source_type,
            data_source_meta,
            visibility,
            visibility_details,
            status,
            status_desc
        )
        VALUES (
            #{datasetId},
            #{datasetTitle},
            #{datasetLabel},
            #{datasetDesc},
            #{ownerAgencyId},
            #{ownerAgencyName},
            #{ownerUserId},
            #{ownerUserName},
            #{datasetFields},
            #{datasetVersionHash},
            #{datasetSize},
            #{datasetRecordCount},
            #{datasetColumnCount},
            #{datasetStorageType},
            #{datasetStoragePath},
            #{dataSourceType},
            #{dataSourceMeta},
            #{visibility},
            #{visibilityDetails},
            #{status},
            #{statusDesc}
        )
    </insert>

    <update id="updateDataset" parameterType="com.webank.wedpr.components.dataset.dao.Dataset">
        UPDATE
            wedpr_dataset
        SET
            dataset_title = #{datasetTitle},
            dataset_label = #{datasetLabel},
            dataset_desc = #{datasetDesc},
            visibility = #{visibility},
            visibility_details = #{visibilityDetails}
        WHERE
            dataset_id = #{datasetId}
    </update>

    <delete id="deleteDataset" parameterType="String">
        DELETE FROM wedpr_dataset WHERE dataset_id = #{datasetId}
    </delete>

    <update id="updateDatasetStatus">
        UPDATE wedpr_dataset SET status = #{status}, status_desc = #{statusDesc} WHERE dataset_id = #{datasetId}
    </update>

    <update id="updateDatasetMetaInfo" parameterType="com.webank.wedpr.components.dataset.dao.Dataset">
        UPDATE
            wedpr_dataset
        SET
            dataset_fields = #{datasetFields},
            dataset_version_hash = #{datasetVersionHash},
            dataset_data_size = #{datasetSize},
            dataset_record_count = #{datasetRecordCount},
            dataset_column_count = #{datasetColumnCount},
            dataset_storage_type = #{datasetStorageType},
            dataset_storage_path = #{datasetStoragePath},
            status = #{status},
            status_desc = #{statusDesc}
        WHERE
            dataset_id = #{datasetId}
    </update>
</mapper>